<html>
<head>
<title>JS Draw!</title>
</head>
<body>
<!-- TODO center the canvas does not work yet -->
<!-- <canvas id="myCanvas" width="1000" height="750" style="background-color: grey; margin-left=auto; margin-right=auto; display=block;"/> -->
<div>
<canvas id="myCanvas" width="1200" height="500" style="background-color: #eee;"></canvas>
</div>
<a id="download" download="my_image.jpg" href="" style="display: none;">Download to my_image.jpg</a>
<script type="text/javascript" src="util.js"></script>
<script type="text/javascript" src="pytha.js"></script>
<script>
function draw_rect_demo(ctx) {
  ctx.fillStyle = "#00ff00";
  ctx.fillRect(0, 0, 20, 40);
}

function draw_circle_demo(canvas, ctx) {
  reset_canvas(canvas, ctx);
  num_circle = rand_int(5, 11);
  color_list = ["#ff0000", "#00ff00", "#0000ff"];
  for (var circ_id = 0; circ_id < num_circle; ++circ_id) {
    x = rand_int(0, canvas.width)
    y = rand_int(0, canvas.height)
    radius = rand_int(20, 50)
    color = color_list[rand_int(0, color_list.length)];
    ctx.fillStyle = color;
    ctx.beginPath()
    ctx.arc(x, y, radius, 0, 3.14 * 2);
    ctx.fill()
  }
  setTimeout(function() { draw_circle_demo(canvas, ctx);}, 1000);
}

function parse_color(color_str) {
  return [parseInt(color_str.substr(1, 2), 16),
    parseInt(color_str.substr(3, 2), 16),
    parseInt(color_str.substr(5, 2), 16)]
}

function color_add(lhs, rhs) {
  if (lhs.length != 7 || rhs.length != 7) {
    console.log(`Invalid input for color_add ${lhs}, ${rhs}`)
    return lhs;
  }
  var lhs_ar = parse_color(lhs)
  var rhs_ar = parse_color(rhs)
  var r = Math.min(255, lhs_ar[0] + rhs_ar[0])
  var g = Math.min(255, lhs_ar[1] + rhs_ar[1])
  var b = Math.min(255, lhs_ar[2] + rhs_ar[2])
  return "#" + r.toString(16).padStart(2, '0')
      + g.toString(16).padStart(2, '0')
      + b.toString(16).padStart(2, '0')
}

// y = yscale * sin(x / xscale)
function draw_sin(canvas, ctx, shift=0, ang=0) {
  reset_canvas(canvas, ctx);
  orig_x = canvas.width / 2
  orig_y = canvas.height / 2
  xscale = 20
  yscale = -20

  for (var x = 0; x < canvas.width - 10; ++x) {
    var y = yscale * Math.sin((x + shift) / xscale);
    ctx.strokeStyle = "#ff0000"
    rot1 = rotate_vec(x, y, ang);
    rot2 = rotate_vec(x, -y, ang);
    draw_pixel(ctx, rot1[0] + orig_x, rot1[1] + orig_y)
    ctx.strokeStyle = "#00ff00"
    draw_pixel(ctx, rot2[0] + orig_x, rot2[1] + orig_y)
  }
  setTimeout(function() { draw_sin(canvas, ctx, shift + 1, ang + 3.14 / 1000); }, 10);
}

var canvas = document.getElementById("myCanvas");
console.log(`canvas width ${canvas.width} height ${canvas.height}`);
var ctx = canvas.getContext("2d");

var cmd = http_get_params()['cmd']
var animate = http_get_params()['animate']
if (!cmd) {
  cmd = "circle"; // default
}
console.log(`cmd is ${cmd}`);

if (cmd == "sin") {
  draw_sin(canvas, ctx)
} else if (cmd == "rect_demo") {
  draw_rect_demo(ctx);
} else if (cmd == "pytha") {
  draw_pythagoras_tree(canvas, ctx, !!animate);
} else if (cmd == "circle") {
  draw_circle_demo(canvas, ctx);
} else {
  alert(`Invalid command ${cmd}`);
}

</script>
</body>
</html>
